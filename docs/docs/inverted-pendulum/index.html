<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=generator content="Wowchemy 5.5.0 for Hugo"><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=preload as=style href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,400;0,700;1,400&family=Istok+Web&family=Roboto+Mono:wght@100;400&display=swap"><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,400;0,700;1,400&family=Istok+Web&family=Roboto+Mono:wght@100;400&display=swap" media=print onload='this.media="all"'><meta name=google-site-verification content="ifyEc9AgWzGakixVyalqxGmn-bz-9iXp9IeGk-LePzc"><meta name=description content="LQR stabilization of an inverted pendulum platform based on a low-cost toy. Simulink model and generation of code for dsPIC Microchip microcontroller are provided (Rapid Control Prototyping: RCP)"><link rel=alternate hreflang=en-us href=https://lubin.kerhuel.eu/docs/inverted-pendulum/><meta name=theme-color content="#bbdefb"><script src=/js/mathjax-config.js></script>
<link rel=stylesheet href=/css/vendor-bundle.min.c7b8d9abd591ba2253ea42747e3ac3f5.css media=print onload='this.media="all"'><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/academicons@1.9.1/css/academicons.min.css integrity="sha512-W0xM4mr6dEP9nREo7Z9z+9X70wytKvMGeDsj7ps2+xg5QPrEBXC8tAW1IFnzjR6eoJ90JmCnFzerQJTLzIEHjA==" crossorigin=anonymous media=print onload='this.media="all"'><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css integrity="sha512-H9jrZiiopUdsLpg94A333EfumgUBpO9MdbxStdeITo+KEIMaNfHNvwyjjDJb+ERPaRS6DpyRlKbvPUasNItRyw==" crossorigin=anonymous media=print onload='this.media="all"'><link rel=stylesheet href=/css/libs/chroma/github-light.min.css title=hl-light media=print onload='this.media="all"' disabled><link rel=stylesheet href=/css/libs/chroma/dracula.min.css title=hl-dark media=print onload='this.media="all"'><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/leaflet.min.css integrity crossorigin=anonymous media=print onload='this.media="all"'><script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js integrity crossorigin=anonymous async></script>
<link rel=stylesheet href=/css/wowchemy.d481ba9ec27304ca481af424b85060cc.css><script>(function(t,s,o,e,a){t[e]=t[e]||[],t[e].push({'gtm.start':(new Date).getTime(),event:"gtm.js"});var i=s.getElementsByTagName(o)[0],n=s.createElement(o),r=e!="dataLayer"?"&l="+e:'';n.async=!0,n.src="https://www.googletagmanager.com/gtm.js?id="+a+r,i.parentNode.insertBefore(n,i)})(window,document,"script","dataLayer","GTM-THRKWJJ")</script><script>(function(e,o,t,i,a,n,s){e[t]=e[t]||function(){(e[t].q=e[t].q||[]).push(arguments)},n=o.createElement(i),n.async=1,n.src="https://www.clarity.ms/tag/"+a,s=o.getElementsByTagName(i)[0],s.parentNode.insertBefore(n,s)})(window,document,"clarity","script","4135mxjybv")</script><link rel=manifest href=/manifest.webmanifest><link rel=icon type=image/png href=/media/icon_hua5ed3a3c5aab9d478a9217a3fd35ab73_87443_32x32_fill_lanczos_center_3.png><link rel=apple-touch-icon type=image/png href=/media/icon_hua5ed3a3c5aab9d478a9217a3fd35ab73_87443_180x180_fill_lanczos_center_3.png><link rel=canonical href=https://lubin.kerhuel.eu/docs/inverted-pendulum/><meta property="twitter:card" content="summary"><meta property="twitter:site" content="@LubinKerhuel"><meta property="twitter:creator" content="@LubinKerhuel"><meta property="og:site_name" content="Rapid Control Prototyping"><meta property="og:url" content="https://lubin.kerhuel.eu/docs/inverted-pendulum/"><meta property="og:title" content="Inverted Pendulum | Rapid Control Prototyping"><meta property="og:description" content="LQR stabilization of an inverted pendulum platform based on a low-cost toy. Simulink model and generation of code for dsPIC Microchip microcontroller are provided (Rapid Control Prototyping: RCP)"><meta property="og:image" content="https://lubin.kerhuel.eu/media/icon_hua5ed3a3c5aab9d478a9217a3fd35ab73_87443_512x512_fill_lanczos_center_3.png"><meta property="twitter:image" content="https://lubin.kerhuel.eu/media/icon_hua5ed3a3c5aab9d478a9217a3fd35ab73_87443_512x512_fill_lanczos_center_3.png"><meta property="og:locale" content="en-us"><meta property="article:published_time" content="2018-09-09T00:00:00+00:00"><meta property="article:modified_time" content="2020-12-07T22:20:07+01:00"><title>Inverted Pendulum | Rapid Control Prototyping</title></head><body id=top data-spy=scroll data-offset=70 data-target=#TableOfContents class="page-wrapper dark" data-wc-page-id=b0ae7d29be8baee87b074905e65b1536><script src=/js/wowchemy-init.min.7139d4fb8f74c01b97e65e19c846e5cc.js></script><aside class=search-modal id=search><div class=container><section class=search-header><div class="row no-gutters justify-content-between mb-3"><div class=col-6><h1>Search</h1></div><div class="col-6 col-search-close"><a class=js-search href=# aria-label=Close><i class="fas fa-times-circle text-muted" aria-hidden=true></i></a></div></div><div id=search-box><input name=q id=search-query placeholder=Search... autocapitalize=off autocomplete=off autocorrect=off spellcheck=false type=search class=form-control aria-label=Search...></div></section><section class=section-search-results><div id=search-hits></div></section></div></aside><div class=page-header><header class=header--fixed><nav class="navbar navbar-expand-lg navbar-light compensate-for-scrollbar" id=navbar-main><div class=container-xl><div class="d-none d-lg-inline-flex"><a class=navbar-brand href=/>Rapid Control Prototyping</a></div><button type=button class=navbar-toggler data-toggle=collapse data-target=#navbar-content aria-controls=navbar-content aria-expanded=false aria-label="Toggle navigation">
<span><i class="fas fa-bars"></i></span></button><div class="navbar-brand-mobile-wrapper d-inline-flex d-lg-none"><a class=navbar-brand href=/>Rapid Control Prototyping</a></div><div class="navbar-collapse main-menu-item collapse justify-content-start" id=navbar-content><ul class="navbar-nav d-md-inline-flex"><li class=nav-item><a class=nav-link href=/#projects><i class="fas fa-car-battery pr-1" style=color:#34c4f4></i><span>Projects</span></a></li><li class=nav-item><a class=nav-link href=/#posts><i class="fas fa-book pr-1" style=color:#34c4f4></i><span>Posts</span></a></li><li class=nav-item><a class=nav-link href=/#about><i class="fas fa-question pr-1" style=color:#34c4f4></i><span>About</span></a></li></ul><ul class="navbar-nav ml-md-auto"><li class=nav-item><a class=nav-link href=/uxv/><i class="fas fa-paper-plane pr-1" style=color:#34c4f4></i><span>UxV blockset</span></a></li><li class=nav-item><a class=nav-link href=https://www.mathworks.com/matlabcentral/fileexchange/71892 target=_blank rel=noopener><i class="fas fa-microchip pr-1" style=color:#34c4f4></i><span>MPLAB blockset</span></a></li></ul></div><ul class="nav-icons navbar-nav flex-row ml-auto d-flex pl-md-2"><li class=nav-item><a class="nav-link js-search" href=# aria-label=Search><i class="fas fa-search" aria-hidden=true></i></a></li></ul></div></nav></header></div><div class=page-body><article class=article><div class="article-container pt-3"><h1>Inverted Pendulum</h1><div class=article-metadata><span class=article-date>Last updated on
December 2020</span></div></div><div class=article-container><div class=article-style><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.3/photoswipe.min.css integrity=sha384-yX+tSqQp3yF8BiTuLLOwNyaqtmZ9yFQT7IYg7U9YU9Dz/JDlh6JJQmNClCmvYl+b crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.3/default-skin/default-skin.min.css integrity=sha384-R6P/wJIrxjHcm//YCjb0S6rRgebsNn3u6U4NxVI8R03iSPAR5CwPqoq1n6U/tjFE crossorigin=anonymous><script src=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.3/photoswipe.min.js integrity=sha384-jkeJ/ETDRD/P4Y3I3CQi1QIwrEJjR9GdAZV2/aqDwwgA5ldCNiExYJeBwKyQC/+q crossorigin=anonymous></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.3/photoswipe-ui-default.min.js integrity=sha384-HotcxRWS6/oszHPwknjGnd066fV8+ycnO5TXDcOscFWvTtaiCtEEv+9s5Qrn1iJD crossorigin=anonymous></script><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><link rel=stylesheet href=/css/hugo-easy-gallery.css><div class=box style=max-width:45%><figure itemprop=associatedMedia itemscope itemtype=http://schema.org/ImageObject><div class=img><img itemprop=thumbnail src=/img/pendulum_platform_top.png loading=lazy alt="Top of the inverted pendulum"></div><a href=/img/pendulum_platform_top.png itemprop=contentUrl></a><figcaption data-pre="Figure " data-post=: class=numbered><p>Top of the inverted pendulum</p></figcaption></figure></div><h1 id=presentation>Presentation</h1><p>Stabilization of an inverted pendulum is a common engineering challenge. Objective is to build a low-cost DIY<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup> platform to test various feedback control loop.</p><p>This document describes the hardware and the theoretical model of the pendulum.
Simulation are presented with Simulink models and an LQR<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup> feedback control loop finally stabilizes the platform.</p><div style=position:relative;padding-bottom:56.25%;height:0;overflow:hidden><iframe src=https://player.vimeo.com/video/309876246 style=position:absolute;top:0;left:0;width:100%;height:100%;border:0 title="vimeo video" webkitallowfullscreen mozallowfullscreen allowfullscreen></iframe></div><p>Video of the stabilized platform with a 4 state LQR feedback loop. The platform is completely autonomous (no user input).</p><p>The electronic placed at the top of the pendulum composed of a dsPIC 16 bits microcontroller and an inertial sensor (accelerometers and rate gyro).
The base of the pendulum is a modified RC toys comprising two wheels driven by two independent DC motor (see <a href=#hw_trolley>pictures below</a>).</p><h1 id=hardware>Hardware</h1><h2 id=overview>Overview</h2><p>The head and the base trolley are described successively. They are separated with an $8mm$ carbon tube.
The pendulum length is $0.52m$ from wheel axis to the top. Wheels diameters is $8cm$. Pendulum total weight is $200g$ comprising $111g$ for the 4 AA batteries.</p><div class=box style=max-width:60%><figure itemprop=associatedMedia itemscope itemtype=http://schema.org/ImageObject><div class=img><img itemprop=thumbnail src=/img/pendulum_platform_reduced_horizontal.png loading=lazy alt="Inverted Pendulum platform"></div><a href=/img/pendulum_platform.jpg itemprop=contentUrl></a><figcaption data-pre="Figure " data-post=: class=numbered><p>Inverted Pendulum platform</p></figcaption></figure></div><h2 id=head-electronics>Head electronics</h2><h3 id=microcontroller>Microcontroller</h3><p>The controller is a <code>Microstick II</code> board equipped with a <code>dsPIC 33EP128MC202</code> running at $70\ MIPS$.
It is powered through the USB connector which <strong>only provide the power supply</strong> from 4 AA batteries hold in the base.</p><div class=box style=max-width:80%><figure itemprop=associatedMedia itemscope itemtype=http://schema.org/ImageObject><div class=img><img itemprop=thumbnail src=/img/pendulum_top.png loading=lazy alt="A prototyping board support a Microstick II board with the dsPIC 33EP128MC202. A board from Drotek endowing the Invensense ICM-20608 inertial sensor is screwed on the base board."></div><a href=/img/pendulum_top.png itemprop=contentUrl></a><figcaption data-pre="Figure " data-post=: class=numbered><h4>Microcontroller and sensor on top of the inverted pendulum</h4><p>A prototyping board support a Microstick II board with the <em>dsPIC 33EP128MC202</em>. A board from Drotek endowing the Invensense ICM-20608 inertial sensor is screwed on the base board.</p></figcaption></figure></div><h3 id=imu-sensor>IMU sensor</h3><p>The unique sensor used is the 6 DoF<sup id=fnref:3><a href=#fn:3 class=footnote-ref role=doc-noteref>3</a></sup> Invensense <code>ICM-20608</code> mounted on a <a href=https://store.drotek.com/sensors/779-imu-6dof-icm20608-invensense-pcb-8944595424761.html target=_blank rel=noopener>Drotek sensor board</a>. It endows:</p><ul><li>a 3 axis Accelerometers and</li><li>a 3 axis rate gyros.</li></ul><p>The I2C blocks set the BUS clock at $400kHz$ and fetch the 6 sensors values every $1ms$ $(1kHz)$.
The Simulink I2C blocks setting enable hot plug of the I2C sensor: The microcontroller initializes the sensor each time it is newly detected on the I2C bus.</p><ul><li>The accelerometer is configured with a range of $\pm 8g$ low pass filtered at $99Hz$.</li><li>The rage gyro is configured with a range of $\pm 500 \deg/s$ low pass filtered at $250Hz$.</li></ul><p>A Simulink IMU<sup id=fnref:4><a href=#fn:4 class=footnote-ref role=doc-noteref>4</a></sup> sub-system run a data fusion algorithm to reconstruct a drift-free quaternion angular position at $1kHz$ (the yaw angle drift when magnetometer is not present).
The stabilization control loop uses the drift-free pitch angle.</p><p>It is possible to use other sensors like the MPU9250 or MPU6050 with either an I2C or SPI interface.
The GY-91 board is a 10 DoF<sup id=fnref:3><a href=#fn:3 class=footnote-ref role=doc-noteref>3</a></sup> widespread board based on the 9 DoF MPU9250 (3 accelerometers, 3 magnetometers, 3 rate gyros) and has a pressure sensor.</p><h3 id=UARTINTERFACE>UART interface</h3><p>The PCB board provides a $3.3V$ regulator and 4 pin extra interface ( GND, +3.3v, Tx, Rx ) to connect either an UART <a href=https://github.com/d-ronin/openlager/wiki target=_blank rel=noopener>data-logger</a> or <a href=http://ardupilot.org/copter/docs/common-sik-telemetry-radio.html#common-sik-telemetry-radio target=_blank rel=noopener>radio link</a> for telemetry module or an <a href=https://www.frsky-rc.com/product/xsr/ target=_blank rel=noopener>RC receiver</a> capable of S.BUS, Smart Port or P.Port protocol (all UART based).</p><h2 id=hw_trolley>Base trolley</h2><h3 id=motors>Motors</h3><p>The base trolley is a low cost a 2-wheel remote control toy named <code>flywheels</code>. The toy is from 2012 but 2 wheeled equivalents exist.
Its electronics is removed.
Two pairs of wires power two DC motors in either direction through an <code>L298N</code> H bridge board module.</p><div class="gallery caption-position-bottom caption-effect-slide hover-effect-zoom hover-transition" itemscope itemtype=http://schema.org/ImageGallery><div class=box><figure itemprop=associatedMedia itemscope itemtype=http://schema.org/ImageObject><div class=img style=background-image:url(/img/pendulum_toysrus_flywheels_package.jpg)><img itemprop=thumbnail src=/img/pendulum_toysrus_flywheels_package.jpg loading=lazy alt="FlyWheels toy package"></div><a href=/img/pendulum_toysrus_flywheels_package.jpg itemprop=contentUrl></a><figcaption><h4>FlyWheels toy package</h4><p>FlyWheels toy package</p></figcaption></figure></div><div class=box><figure itemprop=associatedMedia itemscope itemtype=http://schema.org/ImageObject><div class=img style=background-image:url(/img/pendulum_toysrus_flywheels_open.jpg)><img itemprop=thumbnail src=/img/pendulum_toysrus_flywheels_open.jpg loading=lazy alt="Two DC motors"></div><a href=/img/pendulum_toysrus_flywheels_open.jpg itemprop=contentUrl></a><figcaption><h4>Two DC motors</h4><p>Two DC motors</p></figcaption></figure></div></div><h3 id=power-electronics>Power electronics</h3><p>The L298N H bridge controls two DC motors. For each motor:</p><ul><li>Two logic signals set the 4 states: direction CW or CCW, brake, or freewheel.</li><li>The third logic signal power the motor depending on to the state defined.</li></ul><p>The third signal is modulated with a 100Hz square periodic signal whose duty cycle vary from 0% to 100% (PWM). It sets the torque for the motor.</p><p>The flat multicolor ribbon connects 6 logic control signals (3 for each motor) from the Microstick II dsPIC output to the of the L298N H bridge.</p><div class=box style=max-width:60%><figure itemprop=associatedMedia itemscope itemtype=http://schema.org/ImageObject><div class=img><img itemprop=thumbnail src=/img/pendulum_base.png loading=lazy alt="A L298N H bridge (for Arduino) power board drives the two DC motors of a modified FlyWheels toy. Four AA batteries powers the pendulum."></div><a href=/img/pendulum_base.png itemprop=contentUrl></a><figcaption data-pre="Figure " data-post=: class=numbered><h4>Base trolley of the inverted pendulum</h4><p>A <em>L298N H bridge</em> (for Arduino) power board drives the two DC motors of a modified <em>FlyWheels</em> toy. <em>Four AA batteries</em> powers the pendulum.</p></figcaption></figure></div><h3 id=batteries>Batteries</h3><p>Four $1.2V$ AA Ni-Mh batteries are dispatched on both side of the trolley.
$\approx 4.8V$ powers the motors and the electronics.
The black and red wire from the trolley to the top of the pendulum powers the Microstick II electronic and sensors.</p><h1 id=pendulum-model>Pendulum Model</h1><p>The pendulum model is composed of two intertwined sub-system:</p><ul><li>The pendulum*, with 1 rotation DoF<sup id=fnref:3><a href=#fn:3 class=footnote-ref role=doc-noteref>3</a></sup> $\theta$ angle around the wheel&rsquo;s axis</li><li>The trolley*, with 1 translation DoF<sup id=fnref:3><a href=#fn:3 class=footnote-ref role=doc-noteref>3</a></sup> $x$ position.</li></ul><div class=box style=max-width:100%><figure itemprop=associatedMedia itemscope itemtype=http://schema.org/ImageObject><div class=img><img itemprop=thumbnail src=/img/pendulum-free-body-diagram.png loading=lazy alt="$\vec{P}$ is the weight at the center of gravity. $\vec{R}$ is the reaction force from the stiff rod and the floor. $\vec{F}$ is a friction force when the pendulum is rotating. $\{ \vec{i},\vec{j} \}$ is the earth frame and $\{ \vec{r},\vec{n} \}$ is the rotating pendulum frame. The inertial sensors are placed on top of the pendulum and measure all accelerations."></div><a href=/img/pendulum-free-body-diagram.png itemprop=contentUrl></a><figcaption data-pre="Figure " data-post=: class=numbered><h4>Pendulum free body diagram</h4><p>$\vec{P}$ is the weight at the center of gravity. $\vec{R}$ is the reaction force from the stiff rod and the floor. $\vec{F}$ is a friction force when the pendulum is rotating. $\{ \vec{i},\vec{j} \}$ is the earth frame and $\{ \vec{r},\vec{n} \}$ is the rotating pendulum frame. The inertial sensors are placed on top of the pendulum and measure all accelerations.</p></figcaption></figure></div><h2 id=pendul-equations>Pendul Equations</h2><p>The Dynamic fundamental law applied on the pendulum:
$$ \sum \vec{Force} = m.\vec{a} $$</p><p>The three forces presents are the weight $\vec{P}$, the Friction $\vec{F}$, and the Reaction $\vec{R}$ from the rod & floor:</p><p>$$ \underbrace{ -mg\vec{j} }_{\vec{P}} \ - \ \underbrace{ k \frac{\partial \vec{r}}{\partial t} }_{\vec{F}} \ + \ \underbrace{ ( mg\vec{j} . \vec{r} + \underbrace{Ctfg}_{\text{Centrifugal}} } _{\vec{R} } ) . \vec{r} = ml \frac{\partial^2\vec{ r }}{\partial t^2} $$</p><p>With $ \{ \vec{i},\vec{j} \} $ the static earth frame and $ \{ \vec{r},\vec{n} \} $ the pendulum frame (rod and normal direction).
$m$ is the mass of the pendulum (without the trolley).
$l$ is the length from the inter-wheel&rsquo;s axis to the center of mass of the pendulum (without the trolley)</p><p>$$
\left\{ \begin{array}{rcl}
\vec{i} & = & \vec{n} . cos(\theta) - \vec{r} . sin(\theta) \\\
\vec{j} & = & \vec{n} . sin(\theta) + \vec{r} . cos(\theta)
\end{array} \right.
$$</p><p>$$\vec{j}.\vec{r} = cos(\theta)$$</p><p>Considering the rotation $\theta$, the first and second time derivative of $\vec{r}$ are:</p><p>$$
\begin{array}{rcl}
\frac{\partial \vec{r}}{\partial t}
& = &
- \dot{\theta} \vec{n} \\\
\frac{\partial^2\vec{ r }}{\partial t^2}
& = &
- \frac{\partial }{\partial t} \left( \dot{\theta} \vec{n} \right) \\\
& = &
- \ddot{\theta} \vec{n} - \dot{\theta}^2 \vec{r}
\end{array}
$$</p><p>The projection of the forces equation in the pendulum frame $ \{ \vec{r},\vec{n} \} $ is:
$$
\left\{ \begin{array}{rcl}
\left( ml\dot{\theta}^2 + Ctfg \right) \vec{r} = \vec{0} \\\
\left( l \ddot{\theta} + \frac{k}{m}\dot{\theta} - g . sin(\theta) \right) \vec{n} = \vec{0}<br>\end{array} \right.
$$</p><p>The first equation for the $\vec{r}$ axis shows internal forces which cancel each other: the weight $\vec{P} = -mg\vec{j}$ which is compensated on the $\vec{r}$ axis by the term $mg\vec{j}.\vec{r}$ from the reaction force which will also compensate for the Centrifugal force $ml\dot{\theta}^2$.</p><p>The second differential equation on the $\vec{n}$ axis allows to solve for the evolution of the angle $\theta$.
It can be made linear with $sin(\theta) \approx \theta$ when the pendulum is up near $0$, or with $sin(\theta) \approx - (\theta - \pi)$ when the pendulum is down near $\pi$.</p><div class=box style=max-width:100%><figure itemprop=associatedMedia itemscope itemtype=http://schema.org/ImageObject><div class=img><img itemprop=thumbnail src=/img/pendulum-model-rod.png loading=lazy alt="non-linear model of the $\theta$ angle evolution derived from the forces projected on the normal $\vec{n}$ axis of the rod. The trolley linear acceleration input is added."></div><a href=/img/pendulum-model-rod.png itemprop=contentUrl></a><figcaption data-pre="Figure " data-post=: class=numbered><h4>Pendulum model for rod rotation</h4><p>non-linear model of the $\theta$ angle evolution derived from the forces projected on the normal $\vec{n}$ axis of the rod. The trolley linear acceleration input is added.</p></figcaption></figure></div><p>The linear approximation for $\theta$ in the laplace domain is a $2^{nd}$ order system:
$$ \theta(s) \left ( \frac{1}{w_n^2}s^2 + \frac{2 \zeta}{w_n}s \pm 1 \right ) = 0 $$</p><p>The pendulum transfer function $F_p = \frac{\theta(s)}{E(s)}$ with a null input $E(s) = 1$
$$ F_p(s) = \frac{1}{ \frac{1}{w_n^2}s^2 + \frac{2 \zeta}{w_n}s \pm 1 } $$</p><div class="alert alert-note"><div>The linear term for $sin$ is positive when the pendulum is up when $\theta \approx 0$ (unstable), and negative when pendulum is down when $\theta \approx \pm \pi$ (stable).</div></div><p>This transfer function is characterized when the pendulum is down by its natural frequency $w_n = \sqrt{ \frac{g}{l} } $, and a damping factor $\zeta$.</p><h2 id=pendul-identification>Pendul identification</h2><p>The parameter $l$ could be estimated from the platform mechanical but the damping parameter $\zeta$ (or frictions coefficient $k$) could not be estimated easily from the platform.</p><p>The simulation model is satisfactory when the calculation it performs make realistic prediction.
Experimental measurement is a good method to refine a model and tune its parameters.
In our case, the parameters $l$ and $\zeta$ (or $k$) are identified from the experiment explained below.</p><h3 id=experimental-logs>Experimental logs</h3><p>The pendulum is placed on a track (two chairs back to back) to be able to make a complete rotation.
Motor are off and the pendulum is released up-side with in the unstable condition ($\theta = -18°$ , $\dot \theta = 0$).</p><p>It oscillates until the damping friction ($\zeta$) stops the free oscillations.</p><p>The $1kHz$ sampled rate gyro and accelerometers values are recorded onboard an <a href=https://github.com/d-ronin/openlager/wiki target=_blank rel=noopener>openlager</a> board connected on the dsPIC <a href=#UARTINTERFACE>UART</a> interface.</p><h3 id=simulation-from-logs>Simulation from logs</h3><p>The measured inertial sensors are then re-used as data source in a Simulink model. $\theta$ angle is reconstructed using an IMU complementary filter algorithm implemented in the quaternion angle representation.</p><p>The pendulum model is initialized with the experimentation initial condition ($\theta = -18°$ , $\dot \theta = 0$). Trolley linear acceleration input is null.
Parameters $l$ and $k$ are iteratively tuned until the model $\hat{\theta}$ angle fit with the measured oscillation $\theta$.</p><div class=box style=max-width:100%><figure itemprop=associatedMedia itemscope itemtype=http://schema.org/ImageObject><div class=img><img itemprop=thumbnail src=/img/pendulum-identification-theta.png loading=lazy alt="$\theta$ angle from free oscillation experiment is compared against two pendulum models. The pendulum is released at time $16.7s$ upside ($18°$) and let free to oscillate. The grey curve is the experimental angle reference reconstructed from inertial sensors measurements. The blue dashed curve is a pendulum model using a linear damping with $k = 0.4$. The red doted curve use a nonlinear damping with the nonlinear term -1.1*$sign(\dot{\theta})$ added to the linear damping with $k = 0.17$."></div><a href=/img/pendulum-identification-theta.png itemprop=contentUrl></a><figcaption data-pre="Figure " data-post=: class=numbered><h4>Identification - experimental $\theta$ angle reconstructed from inertial sensors (wide grey curve) vs pendulum model (read and blue dashed curves)</h4><p>$\theta$ angle from free oscillation experiment is compared against two pendulum models. The pendulum is released at time $16.7s$ upside ($18°$) and let free to oscillate. The grey curve is the experimental angle reference reconstructed from inertial sensors measurements. The blue dashed curve is a pendulum model using a linear damping with $k = 0.4$. The red doted curve use a nonlinear damping with the nonlinear term -1.1*$sign(\dot{\theta})$ added to the linear damping with $k = 0.17$.</p></figcaption></figure></div><table><thead><tr><th style=text-align:center>Pendulum Parameters</th><th style=text-align:center>Identified Value</th></tr></thead><tbody><tr><td style=text-align:center>$l$</td><td style=text-align:center>$0.45 m$</td></tr><tr><td style=text-align:center>$k$</td><td style=text-align:center>$0.4$</td></tr><tr><td style=text-align:center>$w_n = \sqrt{\frac{g}{l}}$</td><td style=text-align:center>$4.67\ rad.s^{-1}$ ( $0.74 Hz$ or $1.35s$ period )</td></tr><tr><td style=text-align:center>⬆ Identified pendulum parameters</td><td></td></tr></tbody></table><h3 id=validation-and-imu-improvement>Validation and IMU improvement</h3><p>Parameters $l$ and $k$ can be further validated using the force equation and the estimated pendulum angle $\theta$.</p><p>The IMU input measurements is composed of the rate gyro and the accelerometers data. Magnetometers is not used in this pendulum example.
The IMU input also require the predicted acceleration vector (resp magnetometer is used).
The IMU output the sensor orientation and provides the gravity vector prediction as seen in the sensor estimated attitude (i.e. quaternion angle).</p><p>Comparing the gravity vector predicted with the accelerometer&rsquo;s measurement do not match because the sensor measures both the gravity plus the dynamic acceleration induced by the pendulum movements.</p><p>Considering the pendulum principal movement rotation $\theta$, the equations of forces applied on the pendulum derive from $\hat \theta$ a prediction for the dynamic acceleration.
The good match between the predicted acceleration and the experimental measurement confirm somehow the correctness of parameters $l$ and $k$ involved in these calculations.</p><p>The updated acceleration comprising both a static and dynamic part is fed into the IMU algorithm improving the IMU correction of the rate gyro integration drift even when the pendulum is not static.</p><h1 id=trolley-model>Trolley Model</h1><h2 id=trolley-equations>Trolley Equations</h2><div class="alert alert-warning"><div>Below is under construction 🚧</div></div><p>The translational movement of the trolley is modeled as a $1^{st}$ order system characterized by its time constant $\tau$.
This dynamic includes the motor dynamics when it is loaded with the trolley considering the pendulum as vertical.</p><p>The model considers as negligible the effect of the pendulum forces (translational and rotational) applied on the trolley.</p><p>$$ x(s) = \frac{1}{\tau s + 1} $$</p><h2 id=trolley-identification>Trolley Identification</h2><table><thead><tr><th style=text-align:center>Trolley Parameter</th><th style=text-align:center>Estimated Value</th></tr></thead><tbody><tr><td style=text-align:center>$\tau$</td><td style=text-align:center>$0.3s$</td></tr></tbody></table><p>The trolley does not have any sensors. No encoder or current sensor are used to control the two motors.
The parameters $\tau$ is &ldquo;guessed&rdquo; in a first step.
In a second step, a $2^{nd}$ inertial sensor board is temporary glued in the middle of the wheel diameter to as the inertial sensor is in the wheel rotation axe.
An identification can be computed from the motor set-point and the wheel movements while the pendulum was actively controlled up by a first feedback loop.</p><p>Still the pendulum model including the trolley is simulated with its feedback loop controller and results are compared against recorded data of the real system running the same feedback loop controller. The simulated pendulum states are re-initialized periodically ($\approx 2s$) with the real pendulum states as the model would diverge otherwise due to perturbations not modeled and model discrepancies. Correctness of the model can be checked between theses periodic re-initialization.</p><div class=box style=max-width:45%><figure itemprop=associatedMedia itemscope itemtype=http://schema.org/ImageObject><div class=img><img itemprop=thumbnail src=/img/pendulum-gy91-wheel.jpg loading=lazy alt="The angular speed rate of the wheel is measured with one rate gyro form one added GY-91 sensor board. The GY-91 board is hot glued on one pendulum wheel. The pendulum is stabilized with a controller using an estimated trolley model. Four wires from the GY-91 to the microcontroller power the sensor and retrieve sensor data through the I2C bus (2 wires)."></div><a href=/img/pendulum-gy91-wheel.jpg itemprop=contentUrl></a><figcaption data-pre="Figure " data-post=: class=numbered><h4>Identification of trolley in real inverted pendulum condition.</h4><p>The angular speed rate of the wheel is measured with one rate gyro form one added GY-91 sensor board. The GY-91 board is hot glued on one pendulum wheel. The pendulum is stabilized with a controller using an estimated trolley model. Four wires from the GY-91 to the microcontroller power the sensor and retrieve sensor data through the I2C bus (2 wires).</p></figcaption></figure></div><h1 id=controller>Controller</h1><p><code>Stabilization overview:</code> The microcontroller computes the angle of the pendulum from the inertial sensor measurements (accelerometers and rate gyro). A feedback loop stabilizes the pendulum up right while maintaining the pendulum position still. The pendulum translation is estimated through an internal dynamic model of the trolley stimulated with a copy of the DC motor command. The pendulum slow translations reflect the drift of the internal estimation of the displacement.</p><h2 id=linearized-model>Linearized model</h2><h2 id=lqr-feedback-controller>LQR feedback controller</h2><p>Video of the inverted Pendulum when it encounters a wall:<div style=position:relative;padding-bottom:56.25%;height:0;overflow:hidden><iframe src=https://player.vimeo.com/video/309876329 style=position:absolute;top:0;left:0;width:100%;height:100%;border:0 title="vimeo video" webkitallowfullscreen mozallowfullscreen allowfullscreen></iframe></div></p><p>Another way to stabilize a pendulum with an electric seesaw (<a href=https://sciencedemonstrations.fas.harvard.edu/presentations/inverted-pendulum target=_blank rel=noopener>video</a>).</p><section class=footnotes role=doc-endnotes><hr><ol><li id=fn:1 role=doc-endnote><p>Do It Yourself&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2 role=doc-endnote><p>Linear Quadratic Regulator&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:3 role=doc-endnote><p>Degree of Freedom&#160;<a href=#fnref:3 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:4 role=doc-endnote><p>Inertial Measurement Unit&#160;<a href=#fnref:4 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></section></div><div class=article-tags><a class="badge badge-light" href=/tag/inverted-pendulum/>inverted pendulum</a>
<a class="badge badge-light" href=/tag/state-space/>state space</a>
<a class="badge badge-light" href=/tag/lqr/>LQR</a>
<a class="badge badge-light" href=/tag/rapid-prototyping/>rapid prototyping</a>
<a class="badge badge-light" href=/tag/model-based-design-mbd/>model based design (MBD)</a>
<a class="badge badge-light" href=/tag/matlab/>matlab</a>
<a class="badge badge-light" href=/tag/simulink/>simulink</a>
<a class="badge badge-light" href=/tag/diy/>DIY</a>
<a class="badge badge-light" href=/tag/dspic/>dsPIC</a>
<a class="badge badge-light" href=/tag/l298n/>L298N</a>
<a class="badge badge-light" href=/tag/icm-20608/>ICM-20608</a>
<a class="badge badge-light" href=/tag/microstick-ii/>Microstick II</a>
<a class="badge badge-light" href=/tag/33ep128mc202/>33EP128MC202</a></div><div class=share-box><ul class=share><li><a href="https://twitter.com/intent/tweet?url=https://lubin.kerhuel.eu/docs/inverted-pendulum/&text=Inverted%20Pendulum" target=_blank rel=noopener class=share-btn-twitter aria-label=twitter><i class="fab fa-twitter"></i></a></li><li><a href="https://www.facebook.com/sharer.php?u=https://lubin.kerhuel.eu/docs/inverted-pendulum/&t=Inverted%20Pendulum" target=_blank rel=noopener class=share-btn-facebook aria-label=facebook><i class="fab fa-facebook"></i></a></li><li><a href="mailto:?subject=Inverted%20Pendulum&body=https://lubin.kerhuel.eu/docs/inverted-pendulum/" target=_blank rel=noopener class=share-btn-email aria-label=envelope><i class="fas fa-envelope"></i></a></li><li><a href="https://www.linkedin.com/shareArticle?url=https://lubin.kerhuel.eu/docs/inverted-pendulum/&title=Inverted%20Pendulum" target=_blank rel=noopener class=share-btn-linkedin aria-label=linkedin-in><i class="fab fa-linkedin-in"></i></a></li><li><a href="whatsapp://send?text=Inverted%20Pendulum%20https://lubin.kerhuel.eu/docs/inverted-pendulum/" target=_blank rel=noopener class=share-btn-whatsapp aria-label=whatsapp><i class="fab fa-whatsapp"></i></a></li><li><a href="https://service.weibo.com/share/share.php?url=https://lubin.kerhuel.eu/docs/inverted-pendulum/&title=Inverted%20Pendulum" target=_blank rel=noopener class=share-btn-weibo aria-label=weibo><i class="fab fa-weibo"></i></a></li></ul></div></div></article></div><div class=page-footer></div><script src=/js/vendor-bundle.min.92d2024afaa4dce0cad42ba360879ce9.js></script>
<script src=https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js integrity="sha512-uURl+ZXMBrF4AwGaWmEetzrd+J5/8NRkWAvJx5sbPSSuOb0bZLqf+tOzniObO00BjHa/dD7gub9oCGMLPQHtQA==" crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/leaflet.min.js integrity crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/gh/bryanbraun/anchorjs@4.2.2/anchor.min.js integrity="sha512-I7w3ZdSFzw5j3jU3ZkNikBNeIrl3i+hEuEdwNmqUJvwNcaBUNcijnP2gd9DtGlgVYDplfjGoD8vTNsID+lCjqg==" crossorigin=anonymous></script>
<script>anchors.add()</script><script id=search-hit-fuse-template type=text/x-template>
        <div class="search-hit" id="summary-{{key}}">
          <div class="search-hit-content">
            <div class="search-hit-name">
              <a href="{{relpermalink}}">{{title}}</a>
              <div class="article-metadata search-hit-type">{{type}}</div>
              <p class="search-hit-description">{{snippet}}</p>
            </div>
          </div>
        </div>
      </script><script src=https://cdn.jsdelivr.net/gh/krisk/Fuse@v3.2.1/dist/fuse.min.js integrity="sha512-o38bmzBGX+hD3JHWUFCDA09btWaqrNmoJ3RXLlrysA7PP01Kgs4UlE4MhelE1v5dJR3+cxlR4qQlotsW7jKsnw==" crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/gh/julmot/mark.js@8.11.1/dist/jquery.mark.min.js integrity="sha512-mhbv5DqBMgrWL+32MmsDOt/OAvqr/cHimk6B8y/bx/xS88MVkYGPiVv2ixKVrkywF2qHplNRUvFsAHUdxZ3Krg==" crossorigin=anonymous></script>
<script id=page-data type=application/json>{"use_headroom":true}</script><script src=/js/wowchemy-headroom.e8fd2d733eef6a8bbbe0539398fc0547.js type=module></script>
<script src=/en/js/wowchemy.min.bfdd76800f14cfa1fb49396420911117.js></script>
<script src=/js/wowchemy-map.a26e9d2f7238ba5b868384f1c5bc6477.js type=module></script><div id=modal class="modal fade" role=dialog><div class=modal-dialog><div class=modal-content><div class=modal-header><h5 class=modal-title>Cite</h5><button type=button class=close data-dismiss=modal aria-label=Close>
<span aria-hidden=true>&#215;</span></button></div><div class=modal-body><pre><code class="tex hljs"></code></pre></div><div class=modal-footer><a class="btn btn-outline-primary my-1 js-copy-cite" href=# target=_blank><i class="fas fa-copy"></i> Copy</a>
<a class="btn btn-outline-primary my-1 js-download-cite" href=# target=_blank><i class="fas fa-download"></i> Download</a><div id=modal-error></div></div></div></div></div><script src=/js/wowchemy-publication.68f8d7090562ca65fc6d3cb3f8f2d2cb.js type=module></script></body></html>